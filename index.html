<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>School Attendance</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, Arial, sans-serif;
      min-height:100vh;
      background: url("background/channels4_profile.jpg") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    .overlay {
      background: rgba(0,0,0,0.45);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px;
    }
    .app {
      width: 770px;
      max-width: 56%;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 18px;
      background: linear-gradient(180deg, rgb(255, 255, 255), yellow);
      color: #1a230b;
      border-radius: 55px;
      padding: 55px;
      box-shadow: 0 10px 40px rgba(2, 6, 23, 0.952);
      position: relative;
    }
    header{
      grid-column: 1 / -1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }
    header h1{font-size:19px;margin-bottom:4px}
    header .meta{font-size:15px;color:blue}
    .left { display:flex; flex-direction:column; gap:12px; }
    .card {
      background: #fff;
      border-radius:35px;
      padding:13px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.904);
    }
    .controls {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    select,input {
      padding:8px 45px;
      border-radius:50px;
      border:1px solid #e6e9ef;
      font-size:14px;
      min-width:160px;
    }
    button {
      padding:8px 20px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      background:blue;
      color:#fff;
    }
    button.ghost {
      background:transparent;
      border:1px solid rgba(11,92,255,0.12);
      color:black;
    }
    .list {
      max-height:48vh;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:9px;
    }
    .student {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-radius:8px;
      background: linear-gradient(180deg,#f8fafc,#ffffff);
      border:1px solid #eef2ff04;
      font-size: 14px;
    }
    .student .left {display:flex;gap:10px;align-items:center}
    .badge {
      padding:6px 8px;border-radius:8px;font-weight:700;color:#0b5cff;background:#eef7ff;font-size:13px;
    }
    .name{font-weight:600}
    .time{color:#555;font-size:12px;margin-left:8px;}
    .right { display:flex; flex-direction:column; gap:12px; }
    .stat {
      padding:12px;
      border-radius:10px;
      background: linear-gradient(180deg,#fff,#fbfdff);
      box-shadow: 0 6px 18px rgba(2,6,23,0.04);
    }
    .muted{color:#64748b;font-size:13px}
    #clock {
      position: absolute;
      top: 60px;
      right: 378px;
      background: rgba(11, 255, 113, 0.993);
      padding: 8px 23px;
      border-radius: 80px;
      font-weight:700;
      color:#0b5cff;
      box-shadow: 0 6px 18px rgba(2, 23, 5, 0.295);
    }
    @media (max-width: 920px){
      .app {grid-template-columns: 1fr; padding:14px}
      #clock{position:static;margin-top:6px;justify-self:end}
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="app" role="application" aria-label="School Attendance App">
      <div id="clock" aria-live="polite">00:00:00</div>

      <header>
        <div>
          <h1>School Attendance</h1>
          <div class="meta">Total Students: <span id="totalStudents">168</span></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="exportBtn" class="ghost">CSV export</button>
          <label class="ghost" style="padding:8px 10px;cursor:pointer">
            CSV upload
            <input id="fileInput" type="file" accept=".csv" style="display:none" />
          </label>
          <button id="clearBtn" class="ghost">Clear</button>
        </div>
      </header>

      <!-- LEFT -->
      <section class="left">
        <div class="card">
          <div class="controls">
            <label for="classSelect" class="muted">Grade:</label>
            <select id="classSelect" aria-label="Choose your grade"></select>

            <label for="nameInput" class="muted">Full Name:</label>
            <input id="nameInput" placeholder="Type your full name" aria-label="Student Full Name" />

            <button id="addBtn">Registration</button>
          </div>

          <div class="muted" style="margin-top:12px">Registered Students:</div>
          <div id="presentList" class="list" aria-live="polite"></div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="right">
        <div class="stat">
          <div class="muted">Total arrived</div>
          <div id="presentCount" style="font-size:18px;font-weight:700">0</div>
        </div>

        <div class="stat">
          <div class="muted">Total did not come</div>
          <div id="absentCount" style="font-size:18px;font-weight:700">168</div>
        </div>

        <div class="stat muted">
          <button id="showAbsentBtn" class="ghost" style="width:100%;">Show absentees</button>
          <div id="absentArea" style="max-height:300px;overflow:auto;margin-top:6px"></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const TOTAL_STUDENTS = 168;
    const CLASSES = ["5","6","7","8","9","10","11"];

    const allStudents = {
      "5": ["Ali", "Vali", "Gulbahor", "Dilshod"],
      "6": ["Jasur", "Madina", "Akmal"],
      "7": ["Lola", "Javohir", "Otabek"],
      "8": ["Rustam","Feruza"],
      "9": ["Sardor","Nilufar"],
      "10": ["Aziz","Munisa"],
      "11": ["Bek","Zebo"]
    };

    let presentStudents = [];

    const classSelect = document.getElementById('classSelect');
    const nameInput = document.getElementById('nameInput');
    const addBtn = document.getElementById('addBtn');
    const presentList = document.getElementById('presentList');
    const presentCountEl = document.getElementById('presentCount');
    const absentCountEl = document.getElementById('absentCount');
    const showAbsentBtn = document.getElementById('showAbsentBtn');
    const absentArea = document.getElementById('absentArea');
    const totalStudentsEl = document.getElementById('totalStudents');
    const fileInput = document.getElementById('fileInput');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');

    totalStudentsEl.textContent = TOTAL_STUDENTS;

    CLASSES.forEach(c=>{
      const opt = document.createElement('option'); 
      opt.value = c; 
      opt.textContent = c + "-grade";
      classSelect.appendChild(opt);
    });

    function loadStorage(){
      try{
        const raw = localStorage.getItem('presentStudents_v2');
        if (raw) presentStudents = JSON.parse(raw);
      } catch(e){ presentStudents = []; }
    }
    function saveStorage(){ localStorage.setItem('presentStudents_v2', JSON.stringify(presentStudents)); }

    function updateUI(){
      presentList.innerHTML = '';
      CLASSES.forEach(c=>{
        const arr = presentStudents.filter(s=>s.class===c);
        arr.forEach((s, idx) => {
          const el = document.createElement('div');
          el.className = 'student';
          el.innerHTML = `
            <div class="left">
              <div class="badge">${c}</div>
              <div class="name" style="color:${s.color}">${escapeHtml(s.name)}</div>
              <div class="time">${s.time || ''}</div>
            </div>
            <div><button class="ghost" data-class="${c}" data-index="${idx}">Delete</button></div>
          `;
          presentList.appendChild(el);
        });
      });
      const presentCount = presentStudents.length;
      presentCountEl.textContent = presentCount;
      absentCountEl.textContent = Math.max(0, TOTAL_STUDENTS - presentCount);
      saveStorage();
    }

    function getCurrentTime(){
      const now = new Date();
      return now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }

    function getColorByTime(dateObj){
      const hour = dateObj.getHours();
      if (hour < 16) return "blue";   // 16:00 gacha
      if (hour >= 18) return "red";   // 18:00 dan keyin
      return "black";                 // oraliqda
    }

    function addStudent(){
      const cls = classSelect.value;
      const name = nameInput.value.trim();
      if (!name){ alert("Please, type your full name."); return; }
      if (presentStudents.find(s=>s.name === name && s.class === cls)){
        if (!confirm(`${name} ${cls}-class already registered. Add again?`)) return;
      }
      const now = new Date();
      const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      const color = getColorByTime(now);
      presentStudents.push({class: cls, name: name, time: time, color: color});
      nameInput.value = '';
      updateUI();
    }

    presentList.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-class]');
      if (!btn) return;
      const cls = btn.dataset.class;
      const idx = Number(btn.dataset.index);
      const classArr = presentStudents.filter(s=>s.class===cls);
      const targetName = classArr[idx] ? classArr[idx].name : null;
      if (!targetName) return;
      if (!confirm(`Delete ${targetName} from ${cls}-class?`)) return;
      const gidx = presentStudents.findIndex(s=>s.class===cls && s.name===targetName);
      if (gidx >= 0){ presentStudents.splice(gidx,1); updateUI(); }
    });

    function showAbsent(){
      const absent = [];
      for (const cls of CLASSES){
        const all = (allStudents[cls] || []);
        all.forEach(name => {
          const found = presentStudents.find(s => s.class === cls && s.name.toLowerCase() === name.toLowerCase());
          if (!found) absent.push({class: cls, name});
        });
      }
      if (absent.length === 0){
        absentArea.innerHTML = "<div style='color:green;font-weight:700'>All students are present ðŸŽ‰</div>";
      } else {
        absentArea.innerHTML = absent.map(a => `<div>${escapeHtml(a.name)} (${a.class}-grade)</div>`).join('');
      }
    }

    function exportCSV(){
      const rows = [["class","name","time","color"]];
      presentStudents.forEach(p => rows.push([p.class, p.name, p.time || '', p.color || '']));
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'present_students.csv'; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function updateClock(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");
      document.getElementById('clock').textContent = `${hh}:${mm}:${ss}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    addBtn.addEventListener('click', addStudent);
    showAbsentBtn.addEventListener('click', showAbsent);
    exportBtn.addEventListener('click', exportCSV);
    clearBtn.addEventListener('click', () => { if(confirm("Clear all attendance?")){ presentStudents = []; updateUI(); } });
    fileInput.addEventListener('change', e => {/* import ishlov berish ixtiyoriy */});

    loadStorage();
    updateUI();
  </script>
</body>
</html>
